<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>神秘链接向导</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;700&display=swap');
        body {
            font-family: 'Noto Sans SC', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #1a1a1a;
            color: #e0e0e0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            overflow: hidden;
        }
        .container {
            background-color: #2a2a2a;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            padding: 2.5rem;
            width: 90%;
            max-width: 500px;
            text-align: center;
            border: 1px solid #444;
            transition: all 0.3s ease-in-out;
        }
        .hidden {
            display: none;
        }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.2);
            border-left-color: #4f46e5;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1.5rem;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .summary-text {
            font-size: 1.125rem;
            min-height: 5rem;
            margin: 1.5rem 0;
            color: #c7d2fe;
        }
        .countdown-text {
            color: #9ca3af;
            margin-bottom: 1.5rem;
        }
        .button {
            background-color: #4f46e5;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: bold;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s ease;
            width: 100%;
        }
        .button:hover {
            background-color: #6366f1;
        }
        .fallback-text {
            margin-top: 1rem;
            font-size: 0.875rem;
            color: #9ca3af;
        }
        a {
            color: #818cf8;
            text-decoration: none;
        }
        a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 加载指示器 -->
        <div id="loading-container">
            <div class="spinner"></div>
            <h2 class="text-xl font-bold">✨ 正在召唤一位神秘向导为您解读链接...</h2>
            <p class="text-gray-400 mt-2">请稍候，魔法正在发生。</p>
        </div>

        <!-- 摘要内容 -->
        <div id="summary-container" class="hidden">
            <h2 class="text-2xl font-bold text-indigo-300">神秘向导的低语：</h2>
            <p id="summary-text" class="summary-text">...</p>
            <p id="countdown-text" class="countdown-text">将在 <span id="countdown" class="font-bold">5</span> 秒后自动跳转...</p>
            <button id="proceed-button" class="button">立即前往</button>
        </div>
        
        <!-- 错误或回退显示 -->
        <div id="error-container" class="hidden">
             <h2 class="text-2xl font-bold text-red-400">哎呀，向导走神了...</h2>
             <p class="summary-text">无法生成链接预览。我们将直接带您前往目的地。</p>
        </div>

        <p class="fallback-text mt-4">
            <a id="manual-link" href="https://www.google.com">如果浏览器没有响应，请点击这里</a>
        </p>
    </div>

    <script type="text/javascript">
        document.addEventListener('DOMContentLoaded', () => {
            // --- 配置 ---
            const targetUrl = 'https://www.google.com';
            const apiKey = ""; // Gemini API 密钥将由运行环境提供
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            // --- DOM 元素 ---
            const loadingContainer = document.getElementById('loading-container');
            const summaryContainer = document.getElementById('summary-container');
            const errorContainer = document.getElementById('error-container');
            const summaryText = document.getElementById('summary-text');
            const countdownSpan = document.getElementById('countdown');
            const proceedButton = document.getElementById('proceed-button');
            const manualLink = document.getElementById('manual-link');

            // --- 变量 ---
            let countdownInterval;
            
            // --- 函数 ---

            /**
             * 重定向到目标URL
             */
            const redirectToTarget = () => {
                clearInterval(countdownInterval);
                window.location.replace(targetUrl);
            };
            
            manualLink.href = targetUrl;
            proceedButton.addEventListener('click', redirectToTarget);

            /**
             * 开始倒计时并最终跳转
             * @param {number} seconds - 倒计时秒数
             */
            const startCountdown = (seconds) => {
                let count = seconds;
                countdownSpan.textContent = count;
                
                countdownInterval = setInterval(() => {
                    count--;
                    countdownSpan.textContent = count;
                    if (count <= 0) {
                        redirectToTarget();
                    }
                }, 1000);
            };

            /**
             * 显示摘要内容并开始倒计时
             * @param {string} text - 从API获取的摘要文本
             */
            const displaySummary = (text) => {
                loadingContainer.classList.add('hidden');
                summaryText.textContent = text || "这位向导今天比较害羞，没有留下任何提示。";
                summaryContainer.classList.remove('hidden');
                startCountdown(5);
            };
            
            /**
             * 显示错误信息并准备跳转
             */
            const displayErrorAndRedirect = () => {
                 loadingContainer.classList.add('hidden');
                 errorContainer.classList.remove('hidden');
                 setTimeout(redirectToTarget, 3000); // 显示错误3秒后跳转
            }

            /**
             * 调用 Gemini API 生成摘要
             * @param {string} urlToSummarize - 需要摘要的URL
             */
            const generateSummary = async (urlToSummarize) => {
                const systemPrompt = "你是一位风趣幽默且略带神秘感的互联网向导。用户即将访问一个网址，请用不超过30个字的中文，诙谐地描述一下他们可能会看到的内容。不要过于露骨，不要剧透，也不要评判内容的好坏。你的回答中不要提及网址本身。";
                const userQuery = `我将要访问这个网址: ${urlToSummarize}`;

                const payload = {
                    contents: [{ parts: [{ text: userQuery }] }],
                    tools: [{ "google_search": {} }],
                    systemInstruction: {
                        parts: [{ text: systemPrompt }]
                    },
                };

                let attempt = 0;
                const maxAttempts = 3;
                while (attempt < maxAttempts) {
                    try {
                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (!response.ok) {
                            throw new Error(`API 请求失败，状态码: ${response.status}`);
                        }

                        const result = await response.json();
                        const candidate = result.candidates?.[0];
                        const text = candidate?.content?.parts?.[0]?.text;
                        
                        displaySummary(text);
                        return; // 成功，退出函数

                    } catch (error) {
                        console.error(`尝试 ${attempt + 1} 失败:`, error);
                        attempt++;
                        if (attempt < maxAttempts) {
                            await new Promise(res => setTimeout(res, 1000 * Math.pow(2, attempt))); // 指数退避
                        }
                    }
                }
                
                // 所有尝试均失败
                console.error("调用 Gemini API 最终失败。");
                displayErrorAndRedirect();
            };

            // --- 启动程序 ---
            generateSummary(targetUrl);
        });
    </script>
</body>
</html>

